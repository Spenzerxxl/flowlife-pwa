# FlowLife PWA Nginx Configuration
# /etc/nginx/sites-available/flowlife.frankrath.de

server {
    listen 80;
    server_name flowlife.frankrath.de;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name flowlife.frankrath.de;

    # SSL certificates (Let's Encrypt)
    ssl_certificate /etc/letsencrypt/live/flowlife.frankrath.de/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/flowlife.frankrath.de/privkey.pem;
    
    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # PWA specific
    add_header Service-Worker-Allowed "/";
    
    root /home/frank/flowlife/client/build;
    index index.html;
    
    # Service Worker
    location /service-worker.js {
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }
    
    # Manifest
    location /manifest.json {
        add_header Content-Type "application/manifest+json";
    }
    
    # SPA routing
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # API proxy to n8n
    location /api/webhook/ {
        proxy_pass https://automatisierung.frankrath.de/webhook/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
